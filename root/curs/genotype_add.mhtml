<%args>
$schema
$title
$pub
$multi_organism_mode
$curs_root_uri
</%args>

<div>
<& allele_edit.mhtml,
   editing => 0,
   curs_root_uri => $curs_root_uri &>

<div ng-controller="MultiAlleleCtrl" id="curs-multi-allele-select" class="curs-box">
  <div class="curs-box-title">
Add alleles from the genes below until the genotype is fully specified.
  </div>
  <div class="curs-box-body">

<div class="row">
<div class="col-sm-6 col-md-6">
  <table class="list">
    <thead>
      <tr>
%     for my $col_name (@col_names) {
        <th>
          <% $col_name %>
        </th>
%     }
        <th>
          &nbsp;
        </th>
      </tr>
    </thead>

%   for my $gene (@gene_data) {
    <tr>
%     for my $col_name (@col_names) {
      <td>
        <% $gene->{$col_name} |n %>
      </td>
%     }
      <td>
        <button class="btn btn-xs"
                ng-click="openAlleleEditDialog('<% $gene->{display_name} %>', '<% $gene->{qq|Systematic identifier|} %>', <% $gene->{gene_id} %>)">Add allele ..</button>
      </td>
    </tr>
%   }
  </table>

</div>

<div class="col-sm-6 col-md-6">

  <a title="Click to genotype edit name" href="#"
     editable-text="data.genotype_name">{{ data.genotype_name ? ('Name: ' + data.genotype_name) : "click to add genotype name" }}</a>

  <div ng-show="alleles.length == 0">
    [No alleles added yet]
  </div>

  <div id="multi-allele-genotype" class="ng-cloak" ng-show="alleles.length">

    <div>
      The alleles for <b>{{ data.genotype_identifier }}</b>:
    </div>

  <table class="list">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Expression</th>
      </tr>
    </thead>
    <tbody ng-repeat="allele in alleles">
      <td>{{allele.name}}</td>
      <td>{{allele.type}}</td>
      <td>{{allele.description}}</td>
      <td>{{allele.expression}}</td>
    </tbody>
  </table>
  </div>
</div>
</div>
<button type="submit" class="btn btn-primary curs-finish-button"
        title="{{ isValid() ? '' : 'No alleles yet' }}"
        ng-click="storeAlleles()" ng-disabled="!isValid()">Finish</button>
<button type="submit" class="btn btn-warning curs-finish-button"
        ng-click="cancel()">Cancel</button>
</div>
</div>
</div>

<%init>
use Canto::Curs;
use Canto::Track;
use Canto::Curs::GeneProxy;

my $config = $c->config();

my @all_genes = map {
  Canto::Curs::GeneProxy->new(config => $config, cursdb_gene => $_);
} Canto::Controller::Curs->get_ordered_gene_rs($schema, 'primary_identifier')->all();

my @gene_data = map {
  my $gene = $_;

  my $hash = {
    'Systematic identifier' => $gene->primary_identifier(),
    Name => $gene->primary_name(),
    gene_id => $gene->gene_id(),
    display_name => $gene->display_name(),
  };
  if ($multi_organism_mode) {
    $hash->{Organism} = $gene->organism()->full_name();
  }
  $hash
} @all_genes;

my @col_names = ("Systematic identifier", "Name");

if ($multi_organism_mode) {
  push @col_names, "Organism";
}
</%init>
