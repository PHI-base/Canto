<%args>
$schema
$title
$pub
$multi_organism_mode
$curs_root_uri
</%args>

<div>
<& allele_edit.mhtml,
   editing => 0,
   curs_root_uri => $curs_root_uri &>

<div ng-controller="MultiAlleleCtrl" id="curs-multi-allele-select" class="curs-box">
  <div class="curs-box-title">
<% $title %>
  </div>
  <div class="curs-box-body">
  
  <form name="multi-allele-select">

Add alleles from the genes below until the genotype is fully specified.

  <table class="list">
    <thead>
      <tr>
%     for my $col_name (@col_names) {
        <th>
          <% $col_name %>
        </th>
%     }
        <th>
          &nbsp;
        </th>
      </tr>
    </thead>

%   for my $gene (@gene_data) {
    <tr>
%     for my $col_name (@col_names) {
      <td>
        <% $gene->{$col_name} |n %>
      </td>
%     }
      <td>
        <button class="btn btn-default"
                ng-click="openAlleleEditDialog('<% $gene->{display_name} %>', '<% $gene->{qq|Systematic identifier|} %>', <% $gene->{gene_id} %>)">Add allele ..</button>
      </td>
    </tr>
%   }
  </table>

  <div id="multi-allele-genotype" class="ng-cloak" ng-show="alleles.length">

    <div>
      The alleles for this genotype:
    </div>

  <table class="list">
    <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Expression</th>
        <th>Type</th>
      </tr>
    </thead>
    <tbody ng-repeat="allele in alleles">
      <td>{{allele.name}}</td>
      <td>{{allele.description}}</td>
      <td>{{allele.expression}}</td>
      <td>{{allele.type}}</td>
    </tbody>
  </table>
  </div>

  <input type="submit" id="curs-multi-alleles-submit" class="curs-finish-button"
          name="multi-allele-finish" value="Finish ..." />
</form>
</div>
</div>
</div>

<%init>
use Canto::Curs;
use Canto::Track;
use Canto::Curs::GeneProxy;

my $config = $c->config();

my @all_genes = map {
  Canto::Curs::GeneProxy->new(config => $config, cursdb_gene => $_);
} Canto::Controller::Curs->get_ordered_gene_rs($schema, 'primary_identifier')->all();

my @gene_data = map {
  my $gene = $_;

  my $hash = {
    'Systematic identifier' => $gene->primary_identifier(),
    Name => $gene->primary_name(),
    Product => $gene->product(),
    gene_id => $gene->gene_id(),
    display_name => $gene->display_name(),
  };
  if ($multi_organism_mode) {
    $hash->{Organism} = $gene->organism()->full_name();
  }
  $hash
} @all_genes;

my @col_names = ("Systematic identifier", "Name", "Product");

if ($multi_organism_mode) {
  push @col_names, "Organism";
}
</%init>
