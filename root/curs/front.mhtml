<%args>
$curs_key
$state
$curs_root_uri
$pub
@annotation_type_list
$is_admin_session
</%args>

<div id="curs-front-page">
<div id="curs-gene-list">
<& /curs/gene_list.mhtml, pub => $pub &>
</div>

<& /pub_details.mhtml, pub => $pub &>

% if ($state eq PomCur::Controller::Curs::CURATION_IN_PROGRESS &&
%     !$is_admin_session) {
<button id="curs-finish-publication" class="curs-finish-button">Submit to curators</button>
% } else {
<button id="curs-check-completed" class="curs-finish-button">Approve session</button>
% }

<div id="curs-annotation-tables" class="sect">
% for my $annotation_type (@annotation_type_list) {
<& current_annotation_view.mhtml,
   annotation_type => $annotation_type,
   pub => $pub,
   curs_root_uri => $curs_root_uri &>

% _increment_annotation_count($annotation_type->{name}, \$annotation_count);
% }

% if ($annotation_count > 0) {
<div id="curs-annotation-download">
  <a href="<% $download_action %>">Download all annotation (Zip format) ...</a>
</div>
% }
</div>
</div>


<%init>
my $annotation_count = 0;

sub _increment_annotation_count
{
  my $annotation_type_name = shift;
  my $annotation_count_ref = shift;

  my $st = $c->stash();
  my $schema = $st->{schema};

  my $rs = $schema->resultset('Annotation')
               ->search({ type => $annotation_type_name });

  $$annotation_count_ref += $rs->count();
}

my $download_action = $curs_root_uri . '/annotation/zipexport';
</%init>
