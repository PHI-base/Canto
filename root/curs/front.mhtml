<%args>
$curs_key
$state
$curs_root_uri
$pub
@annotation_type_list
</%args>

<div id="curs-front-page">
<div id="curs-gene-list">
<& /curs/gene_list.mhtml, pub => $pub &>
</div>

<div class="pub-title curs-box">
  <div class="curs-box-title">
Publication title
  </div>
  <div class="curs-box-body">
<% $pub->title() %>
  </div>
</div>

<div class="curs-annotation-tables sect">
% for my $annotation_type (@annotation_type_list) {
<& current_annotation_view.mhtml,
   annotation_type => $annotation_type,
   curs_root_uri => $curs_root_uri &>

% _increment_annotation_count($annotation_type->{name}, \$annotation_count);
% }

% if ($annotation_count > 0) {
<div class="curs-annotation-download">
  <a href="<% $download_action %>">Download all annotation (Zip format) ...</a>
</div>
% }
</div>
</div>


<%init>
my $current_gene_id = $c->stash()->{current_gene_id};

my $annotation_count = 0;

sub _increment_annotation_count
{
  my $annotation_type_name = shift;
  my $annotation_count_ref = shift;

  my $st = $c->stash();
  my $schema = $st->{schema};

  my $rs = $schema->resultset('Annotation')
               ->search({ type => $annotation_type_name });

  $$annotation_count_ref += $rs->count();
}

my $download_action = $curs_root_uri . '/annotation/zipexport';

</%init>
