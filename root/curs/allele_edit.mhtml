<%args>
$curs_root_uri
$editing
</%args>

<script language="javascript" type="text/javascript">
var allele_types = <% $allele_types_js |n %>;
var alleles_in_progress = <% $alleles_in_progress_js |n %>;
var existing_alleles_by_name = <% $existing_alleles_by_name_js |n %>;
var current_conditions = <% $current_conditions_js |n %>;
var delete_icon_uri = "<% $delete_icon_uri %>";
var editing_allele = <% $editing ? 'true' : 'false' %>;
</script>

<script type="text/ng-template" id="alleleEdit.html">
  <form name="cursAlleleEdit" class="curs-allele-edit-dialog modal-content">
    <div class="modal-header">
      <h4 class="modal-title">
        Allele details for {{ gene.display_name }}
      </h4>
    </div>

    <div class="modal-body">
      <div ng-switch="!!alleleData.primary_identifier">
      <div ng-switch-when="false">
      <table>
        <tr>
          <td>
            Allele name:
          </td>
          <td ng-class="{ 'has-error': !isValidName() }">
            <allele-name-complete allele-primary-identifier="alleleData.primary_identifier"
                                  allele-name="alleleData.name"
                                  allele-description="alleleData.description"
                                  allele-type="alleleData.type"
                                  gene-identifier="gene.systemtic_id">
            </allele-name-complete>
            <span ng-show="!isValidName()"
                  class="help-block">required for this allele type</span>
          </td>
        </tr>

        <tr class="curs-allele-type-select">
          <td>
            Allele type
          </td>
          <td ng-class="{ 'has-error': !isValidType() }">
            <select class="form-control"
                    ng-model="alleleData.type" name="curs-allele-type"
                    ng-options="name for name in env.allele_type_names">
              <option selected="selected" value="">Choose an allele type ...</option>
            </select>
            <span ng-show="!isValidType()"
                  class="help-block">Please choose a type</span>
          </td>
        </tr>

        <tr class="curs-allele-type-description ng-cloak"
            ng-show="!!alleleData.type && current_type_config.description_required">
          <td>
            Allele description
          </td>
          <td ng-class="{ 'has-error': !isValidDescription() }">
            <input ng-model="alleleData.description"
                   name="curs-allele-description-input" type="text" value=""
                   class="form-control" />
            <span ng-show="!isValidDescription()"
                  class="help-block">required for this allele type</span>
          </td>
        </tr>

        <tr class="ng-cloak" ng-show="!!alleleData.type">
          <td>
          </td>
          <td id="curs-allele-description-example">
            {{ current_type_config.placeholder }}
          </td>
        </tr>

        <tr class="curs-allele-expression ng-cloak" ng-show="!!alleleData.type && current_type_config.allow_expression_change">
          <td valign="top">
            Expression
          </td>
          <td>
            <div>
              <label>Overexpression</label>
              <input ng-model="alleleData.expression" name="curs-allele-expression"
                     type="radio" value="Overexpression" />
            </div>
            <div ng-show="alleleData.type !== 'wild type'">
              <label>Endogenous</label>
              <input ng-model="alleleData.expression" name="curs-allele-expression"
                     type="radio" value="Endogenous" />
            </div>
            <div>
              <label>Knockdown</label>
              <input ng-model="alleleData.expression" name="curs-allele-expression"
                     type="radio" value="Knockdown" />
            </div>
            <div ng-show="alleleData.type !== 'wild type'">
              <label>Null</label>
              <input ng-model="alleleData.expression" name="curs-allele-expression"
                     type="radio" value="Null" />
            </div>
            <div ng-show="alleleData.type !== 'wild type'">
              <label>Not specified</label>
              <input ng-model="alleleData.expression" name="curs-allele-expression"
                     type="radio" value="Not specified" />
            </div>
          </td>
        </tr>
      </table>

      <div class="ng-cloak" ng-show="!!alleleData.type && false">
        <table>
          <tr>
            <td>
              Evidence
            </td>
            <td>
              <select ng-model="alleleData.expression" name="curs-allele-evidence-select" class="required curs-allele-evidence-select">
                <option selected="selected" value="">Choose an evidence type ...</option>
% for my $opt (@evidence_select_options) {
                <option value="<% $opt->[0] %>"><% $opt->[1] %></option>
% }
              </select>
            </td>
          </tr>
        </table>
      </div>
      </div>
      <div ng-switch-when="true" class="curs-box">
        <div class="curs-box-title">
          This is an existing allele, click "OK" to use this allele or
          "Cancel" to create a new allele
        </div>
        <div class="curs-box-body">
          <table class="curs-definition-table">
            <tr>
              <td class="title">
                Allele name
              </td>
              <td>
                {{alleleData.name}}
              </td>
            </tr>
            <tr>
              <td class="title">
                Type
              </td>
              <td>
                {{alleleData.type}}
              </td>
            </tr>
            <tr>
              <td class="title">
                Description
              </td>
              <td>
                {{alleleData.description}}
              </td>
            </tr>
            <tr ng-if="current_type_config.allow_expression_change">
              <td class="title">
                Expression
              </td>
              <td>
                {{alleleData.expression}}
              </td>
            </tr>
          </table>
        </div>
      </div>
      </div>

      <div class="ng-cloak" ng-show="!!alleleData.type && false">
        <div class="curs-allele-reuse">
          <input type="checkbox" name="curs-allele-reuse-dialog" value="Reuse"/>Re-use allele name and description with a different set of conditions<br/>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-warning" ng-click="cancel()">Cancel</button>
        <button class="btn btn-primary" ng-click="ok()" ng-disabled="!isValid()">OK</button>
      </div>
    </div>
  </form>
</script>

<%init>
use Data::JavaScript::Anon;

my $st = $c->stash();

my $allele_type_config = $st->{allele_type_config};
my $allele_types_js = Data::JavaScript::Anon->anon_dump($allele_type_config);

my $alleles_in_progress = $st->{alleles_in_progress};
my $alleles_in_progress_js = Data::JavaScript::Anon->anon_dump($alleles_in_progress);

my @evidence_select_options = @{$st->{evidence_select_options} // []};

my $existing_alleles_by_name = $st->{existing_alleles_by_name} // [];
my $existing_alleles_by_name_js = Data::JavaScript::Anon->anon_dump($existing_alleles_by_name);

my $current_conditions = $st->{current_conditions};
my $current_conditions_js = Data::JavaScript::Anon->anon_dump($current_conditions);

my $delete_icon_uri = $c->uri_for('/static/images/delete_icon.png');
</%init>
