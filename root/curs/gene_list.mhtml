<%args>
$title => 'Genes'
$pub
</%args>

<div class="gene-list curs-box">
  <div class="curs-box-title">
    <div>Choose a gene to annotate:</div>
  </div>
  <div class="curs-box-body">
% if (@gene_hashes) {
  <table>
%   for my $gene (@gene_hashes) {
    <tr>
%     for my $col_name (@col_names) {
      <td>
        <a href="<% $start_path . '/gene/' .$gene->{gene_id} %>"
          <span>
            <% $gene->{$col_name} %>
          </span>
        </a>
        <% $gene->{extra_text} %>
      </td>
%     }
    </tr>
%   }
  </table>
% } else {
  <div class="no-genes-message">
    [No genes]
  </div>
% }

  <div class="view-edit">
    <a href="<% $edit_path %>">View or edit list ...</a>
  </div>
  </div>
</div>

<%init>
use PomCur::Curs;

my $schema = $c->stash()->{schema};
my @all_genes = 
  PomCur::Controller::Curs::get_ordered_gene_rs($schema, 'primary_name')->all();
my @gene_hashes = map {
     my $extra_text = '';
     my @annotations = $_->direct_annotations();
     if (@annotations) {
       my $annotation_count = scalar(@annotations);
       my $text;
       if ($annotation_count == 1) {
         $text = '1 annotation';
       } else {
         $text = "$annotation_count annotations";
       }
       $extra_text = "&nbsp;&nbsp;<span class='annotation-count'>($text)</span>";
     }
     {
       identifier => $_->primary_name() || $_->primary_identifier(),
       gene_id => $_->gene_id(),
       extra_text => $extra_text,
     }
   } @all_genes;

my @col_names = qw(identifier);

my $start_path = $c->stash()->{curs_root_uri};
my $upload_path = "$start_path/gene_upload";
my $edit_path = "$start_path/edit_genes";
</%init>
