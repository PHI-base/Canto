<%args>
@annotation_type_list
$curs_root_path
</%args>

% if (@annotations) {
<div>
  Current annotations:
</div>
<table class="list">
  <thead>
    <tr>
      <th>
        Systematic identifier
      </th>
      <th>
        Gene name
      </th>
      <th>
        Annotation type
      </th>
      <th>
        Term ID
      </th>
      <th>
        Term name
      </th>
      <th>
        Evidence type
      </th>
      <th>
      </th>
    </tr>
  </thead>

% for my $row (@annotations) {
  <tr>
    <td>
      <% $row->{gene_identifier} %>
    </td>
    <td>
      <% $row->{gene_name} %>
    </td>
    <td>
      <% $row->{annotation_type} %>
    </td>
    <td>
      <% $row->{term_ontid} %>
    </td>
    <td>
      <% $row->{term_name} %>
    </td>
    <td>
      <% $row->{evidence_type} %>
    </td>
    <td>
      <a href="<% $delete_action . $row->{annotation_id} %>">
        <img src="<% $delete_icon_uri %>"/>
      </a>
    </td>
  </tr>
% }
</table>
% }

<%init>
my @annotations = ();

my $st = $c->stash();
my $schema = $st->{schema};

my $gene_rs = $schema->resultset('Gene');

my $config = $c->config();

my $lookup = PomCur::Track::get_lookup($config, 'go');

while (defined (my $gene = $gene_rs->next())) {
  my $an_rs = $gene->annotations();

  while (defined (my $annotation = $an_rs->next())) {
    my $data = $annotation->data();
    my $term_ontid = $data->{term_ontid};
    my $annotation_type = $annotation->type();
    my $annotation_type_display_name =
      $config->{annotation_types}->{$annotation_type}->{display_name};
    my $result =
      $lookup->web_service_lookup(ontology_name => $annotation_type,
                                  search_string => $term_ontid);

    my $term_name = $result->[0]->{name};

    push @annotations, { gene_identifier => $gene->primary_identifier(),
                         gene_name => $gene->primary_name(),
                         annotation_type => $annotation_type_display_name,
                         annotation_id => $annotation->annotation_id(),
                         term_ontid => $term_ontid,
                         term_name => $term_name,
                         evidence_type => $data->{evidence_type},
                       };
  }
}

my $delete_action = $curs_root_path . '/annotation/delete/';
my $delete_icon_uri = $c->uri_for('/static/images/delete_icon.png');

</%init>
