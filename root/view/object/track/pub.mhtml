<%args>
$object
$class_info
$schema
$is_admin_user
</%args>


<&| /view/object/object_top.mhtml, object => $object, class_info => $class_info &>

% if ($is_admin_user) {
%   if (defined $object->corresponding_author()) {
%     if (scalar($object->curs()->all()) == 0) {
<div class="long-action-link">
  <a href="<% $c->uri_for('/tools/create_curs',
                          { pub => $pub_id,
                            curator =>
                              $object->corresponding_author()->person_id()
                          }) %>">
    Create a curation session for this publication
  </a>
</div>
%     }
%   } else {

<div id="curs-pub-assign-dialog" style="display: none">
  <form id="curs-pub-assign-form" method="put"
        action="<% $c->uri_for('/track/assign_pub') %>">
    <input type="hidden" name="pub-id" value="<% $pub_id %>"/>
    <input type="hidden" name="pub-view-path" value="<% $current_pathquery %>"/>

    <& /person_picker.mhtml, id_prefix => 'pub-corresponding-author',
      default_person => $object->corresponding_author() &>

    <div id="curs-pub-assign-help" class="ferret-help-text">
      Choose a curator to assign this publication to.  A session will
      then be automatically created for the publication.
    </div>
    <input id="curs-pub-assign-cancel" name="curs-pub-assign-cancel" type="submit"
           value="Cancel" class="button"/>
    <input name="curs-pub-assign-submit" type="submit"
           value="Assign" class="button"/>
  </form>
</div>

<div class="curs-pub-assign-actions">
  <button type="button" id="curs-pub-assign-popup-dialog"><% $assign_to_text %></button>
</div>
%   }
<div class="curs-pub-assign-actions">
  <button type="button" value="<% $pub_id %>" id="curs-pub-triage-this-pub">Triage</button>
</div>
% }
<div class="clearall"/>

% if (defined $curs_key) {
%  if ($curs_count == 1) {
<div class="curs-pub-go-to-curs-actions">
  <div class="object_sub_action">
    <a href="<% $c->uri_for('/curs/' . $curs_key) %>">
      Go to the curation session ...
    </a>
  </div>
</div>
%   }
% }

</&>

<div id="collections">
  <& /view/collection.mhtml, object => $object, collection_name => 'curs',
     collection_title => "Curation sessions" &>
  <& /view/collection.mhtml, object => $object,
    collection_name => 'pub_curation_statuses',
    collection_title => 'Status for all curation types' &>
  <& /view/collection.mhtml, object => $object,
    collection_name => 'pubprops',
    collection_title => 'Publication properties' &>
</div>

<& /person_picker_add.mhtml, default_person => $object->corresponding_author() &>

<%init>
use PomCur::Curs;

my $pub_id = $object->pub_id();

my $current_pathquery = $c->req->uri()->path_query();
my $person_rs = $schema->resultset('Person');

my @people_data = ();

while (defined (my $person = $person_rs->next())) {
  push @people_data, { id => $person->person_id(),
                       text => $person->name() . ' <' . $person->email_address() . '>' };
}

my $assign_to_text;

#if (defined $object->corresponding_author()) {
#  $assign_to_text = 'Change the corresponding author ...';
#} else {
  $assign_to_text = 'Set the corresponding author ...';
#}

my $curs_key = undef;
my $curs_rs = $schema->resultset('Curs')->search({ pub => $pub_id});
my $curs_count = $curs_rs->count();
my $curs = $curs_rs->first();

if (defined $curs) {
  $curs_key = $curs->curs_key();
}
</%init>
