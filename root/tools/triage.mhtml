<%args>
$pub
</%args>

<div class="triage">
  <form id="triage-form" action="" method="get">
    <input type="hidden" id="triage-pub-id" name="triage-pub-id"
           value="<% $pub->pub_id() %>"/>
    <div class="pub-details">
      <div class="sect title">
        <span class="sect-title">
          Title
        </span>
        <div class="sect-content">
          <% $pub->title() %>
        </div>
      </div>
      <div class="sect authors">
        <span class="sect-title">
          Authors
        </span>
        <div class="sect-content">
          <% $pub->authors() %>
        </div>
      </div>
      <div class="sect abstract">
        <span class="sect-title disclosed-title">
          <a href="#">Abstract</a>
        </span>
        <div class="sect-content" style="display: none">
          <% $pub->abstract() %>
        </div>
      </div>
      <div class="sect experiment-types">
        <span class="sect-title">
          Experiment types
        </span>
        <div class="sect-content">
% for my $experiment_type (@experiment_types) {
          <div>
            <input type="checkbox" name="experiment-type"
                   value="<% $experiment_type %>" ><% $experiment_type %><br>
          </div>
% }
        </div>
      </div>
      <div class="sect triage-curation-priorities">
        <span class="sect-title">
          Curation priority
        </span>
        <div class="sect-content">
% for my $curation_priority (@curation_priorities) {
          <div>
            <input type="radio" group="triage-curation-priorities"
                   name="triage-curation-priority"
                   value="<% $curation_priority->{cvterm_id} %>"
%   if ($curation_priority->{name} eq $default_priority_name) {
                   checked="true"
%   }
                   >
            <% ucfirst $curation_priority->{name} %><br>
          </div>
% }
        </div>
      </div>
      <div class="sect triage-assigned-curator">
        <span class="sect-title">
          Assign to curator:
        </span>
        <div class="sect-content">
          <input id="triage-assigned-curator-input" name="triage-assigned-curator-input"/>
          <input id="triage-assigned-curator-person-id" name="triage-assigned-curator-person-id" type="hidden"/>
        </div>
      </div>
    </div>
    <div class="status-settings">
      <div class="sect status-choice">
        <span class="sect-title">
          <a href="#">Actions ...</a>
        </span>
        <div class="sect-content">
          <ul>
% for my $status_info (@status_links) {
            <li>
              <input type="submit" name="submit"
              value="<% $status_info->{name} %>">
            </li>
% }
          </ul>
        </div>
      </div>
    </div>

  </form>
  <div class="clearall"/>

</div>


<script>
  var triage_assign_people = [
% for my $person_data (@people_data) {
    {
      label: "<% $person_data->name() %>",
      value: "<% $person_data->person_id() %>",
    },
% }
  ];
</script>

<%init>
my $schema = $c->schema('track');
my $status_cv_name = 'PomCur publication triage status';
my $status_cv = $schema->find_with_type('Cv', { name => $status_cv_name });

my @status_links = ();

my @pub_statuses =
  $schema->resultset('Cvterm')->search({ cv_id => $status_cv->cv_id() });

for my $status (@pub_statuses) {
  my $name = $status->name();

  if ($name eq 'New') {
    next;
  }

  my $status_id = $status->cvterm_id();
  my $path = '/tools/triage/' . $pub->pub_id() .
    '/status/' . $status_id;
  my $link = $c->uri_for($path);

  push @status_links, { name => $name,
                        link => $link };  
}

my $experiment_type_cv_name = 'PomCur publication experiment types';
my $experiment_type_cv =
  $schema->find_with_type('Cv', { name => $experiment_type_cv_name });

my @experiment_type_cvterms =
  $schema->resultset('Cvterm')->search({ cv_id => $experiment_type_cv->cv_id() });

my @experiment_types = map { $_->name() } @experiment_type_cvterms;

my $curation_priority_cv_name = 'PomCur curation priorities';
my $curation_priority_cv =
  $schema->find_with_type('Cv', { name => $curation_priority_cv_name });

my @curation_priority_cvterms =
  $schema->resultset('Cvterm')->search({ cv_id => $curation_priority_cv->cv_id() });

my @curation_priorities = 
  map {
    {
      name => $_->[0],
      cvterm_id => $_->[2],
    }
  } sort {
    $b->[1] <=> $a->[1];
  } map {
    my $numeric_priority = $_->cvtermprop_cvterms()->
      search({ 'type.name' => 'PomCur numeric prioritity' },
             { join => 'type' })->first()->value();
    [ $_->name(), $numeric_priority, $_->cvterm_id() ];
  } @curation_priority_cvterms;

my $default_priority_name = $c->config()->{default_curation_priority_name};

my @people_data = $schema->resultset('Person')->all();

</%init>
